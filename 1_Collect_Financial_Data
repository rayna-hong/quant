import csv
from io import BytesIO
import requests
from bs4 import BeautifulSoup
from lxml import html
import pandas as pd

b_url  = 'https://finance.naver.com/sise/sise_deposit.naver'
b_res  = requests.get(b_url, headers={'User-agent' : 'Mozilla/5.0'})
b_tree = html.fromstring(b_res.content)
b_day  = b_tree.xpath('//*[@id="type_0"]/div/ul[2]/li/span')

biz_date = b_day[0].text.replace('\xa0\xa0|\xa0\xa0', '').replace('.', '')

gen_otp_url = 'http://data.krx.co.kr/comm/fileDn/GenerateOTP/generate.cmd'
down_url    = 'http://data.krx.co.kr/comm/fileDn/download_csv/download.cmd'
headers     = {'Referer' : 'http://data.krx.co.kr/contents/MDC/MDI/mdiLoader'}

mktId = ['STK', 'KSQ'] # 코스피 STK, 코스닥 KSQ

combined_down_sector = pd.DataFrame()

for m in mktId:

    otp_data = {
        'mktId' : m, 
        'trdDd' : biz_date,
        'money' : '1',
        'csvxls_isNo' : 'false',
        'name'  : 'fileDown',
        'url'   : 'dbms/MDC/STAT/standard/MDCSTAT03901'
    }
    
    otp = requests.post(gen_otp_url, otp_data, headers=headers).text
    
    if m == 'STK':
        down_sector_KS = requests.post(down_url, {'code' : otp}, headers=headers)
        sector_KS = pd.read_csv(BytesIO(down_sector_KS.content), encoding='EUC-KR')
        combined_down_sector = pd.concat([combined_down_sector, sector_KS])

    if m == 'KSQ':
        down_sector_KQ = requests.post(down_url, {'code' : otp}, headers=headers)
        sector_KQ = pd.read_csv(BytesIO(down_sector_KQ.content), encoding='EUC-KR')
        combined_down_sector = pd.concat([combined_down_sector, sector_KQ])

folder = '/Users/hyeryounhong/Dropbox/python_practice/Quant_practice/'
combined_down_sector.to_csv(folder + 'krx_sector.csv', index=False)
print(combined_down_sector)

otp_data_ind = {
    'searchType' : '1',
    'mktId' : 'ALL', 
    'trdDd' : biz_date,
    'csvxls_isNo' : 'false',
    'name'  : 'fileDown',
    'url'   : 'dbms/MDC/STAT/standard/MDCSTAT03501'
}
    
otp = requests.post(gen_otp_url, otp_data_ind, headers=headers).text
    
down_ind = requests.post(down_url, {'code' : otp}, headers=headers)
down_ind = pd.read_csv(BytesIO(down_ind.content), encoding='EUC-KR')
#print(down_ind)

folder = '/Users/hyeryounhong/Dropbox/python_practice/Quant_practice/'
down_ind.to_csv(folder + 'krx_ind.csv', index=False)
